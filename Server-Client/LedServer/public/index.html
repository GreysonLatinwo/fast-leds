<!DOCTYPE>
<html>
  <head>
      <title>Realtime Frequency Analytics</title>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:200">
      <link rel="stylesheet" href="./style.css">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
          .strokeme
            {
                color: white;
                text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;  
            }
      </style>
      <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
      <script>
        function setEnergyLevel(eLevel) {
            let xmlHttpReq = new XMLHttpRequest();
            xmlHttpReq.open("GET", "/music/setEnergyLevel?"+Number(129-eLevel));
            xmlHttpReq.send();
        }

        function setColorShift(cShift) {
            let xmlHttpReq = new XMLHttpRequest();
            xmlHttpReq.open("GET", "/music/setColorShift?"+Number(cShift));
            xmlHttpReq.send();
        }

        function setColorBrightness(cBrightness) {
            let xmlHttpReq = new XMLHttpRequest();
            xmlHttpReq.open("GET", "/music/setColorBrightness?"+Number(cBrightness));
            xmlHttpReq.send();
        }
      </script>
  </head>

  <body style="background-color: #7700FF;">
    <div id="myPlot" ></div>
    <div>
        <input type="range" class="form-range" value="113" min="1" max="128" id="eLevel" style="width: 95%;" oninput="this.nextElementSibling.value = 'Set Energy Level: '+this.value" onchange="setEnergyLevel(this.value)">
        <output class="h3 strokeme">Set Energy Level: 113</output>
        <input type="range" class="form-range" value="0" min="0" max="360" id="cShift" style="width: 95%;" oninput="this.nextElementSibling.value = 'Set Color Shift: '+this.value" onchange="setColorShift(this.value)">
        <output class="h3 strokeme">Set Color Shift: 0</output>
        <input type="range" class="form-range" value="255" min="0" max="255" id="cShift" style="width: 95%;" oninput="this.nextElementSibling.value = 'Set Brightness: '+this.value" onchange="setColorBrightness(this.value)">
        <output class="h3 strokeme">Set Brighness: 255</output>
    </div>
    <script>
        var fps = 15
        const updateInterval = Math.trunc((1/fps)*1000)

        var xArray = [50,60,70,80,90,100,110,120,130,140,150];
        var yArray = [7,8,8,9,9,9,10,11,14,14,15];

        // Define Data
        var data = [{
        x: xArray,
        y: yArray,
        mode:"lines"
        }];

        // Define Layout
        var layout = {
            width: window.innerWidth,
            height: window.innerHeight,
            xaxis: {range: [40, 160], title: "Square Meters"},
            yaxis: {range: [-100, 100], title: "Price in Millions"},  
            title: "House Prices vs. Size"
        };

        // Display using Plotly
        Plotly.newPlot("myPlot", data, layout);

        function range(start, end) {
            var ans = [];
            for (let i = start; i < end; i++) {
                ans.push(i);
            }
            return ans;
        }

        function pad(num, size) {
            while (num.length < size) num = "0" + num;
            return num;
        }

        function updateGraph(){
            //get data
            fetch('/music/getData', {
                method: 'get',
                mode: "no-cors"
            })
            .then(response => {
                response.json().then(fftData => {
                    r = fftData.Color[0].toString(16).toUpperCase()
                    g = fftData.Color[1].toString(16).toUpperCase()
                    b = fftData.Color[2].toString(16).toUpperCase()

                    r = pad(r, 2)
                    g = pad(g, 2)
                    b = pad(b, 2)

                    document.body.style.backgroundColor = "#"+r+g+b
                    var data = [{
                        x: fftData.Freq,
                        y: fftData.Power,
                        mode:"lines"
                    }];
                    var layout = {
                        width: window.innerWidth,
                        height: window.innerHeight*0.66,
                        xaxis: {
                            range: [0, 2800], //48-4096
                            title: "Hz",
                            //type: 'log',
                        },
                        yaxis: {range: [-30, 150], title: "dB"},  
                        title: "FFT"
                    };
                    Plotly.react("myPlot", data, layout)

                })
            });
        }

        myInterval = setInterval(updateGraph, updateInterval);

    </script>
  </body>
</html>